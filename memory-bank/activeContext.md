# ペヨーテの旅路 - アクティブコンテキスト

## 現在の作業焦点

- **ゲームバランスの調整**: 影響力システムとレベル進行の難易度調整
- **敵キャラクターのアニメーション修正**: 上下移動時のアニメーション方向を修正（上向き・下向きのスプライト対応）
- **ゲームクリア後のリトライ機能の改善**: 画面全体をタップ可能領域として設定
- **エフェクト処理の安定化**: 粒子エフェクトをより互換性の高い実装に変更、エラーハンドリング追加

## 最近の変更点

### バランス調整
1. 影響力システムの弱体化とバランス調整
   - 影響力の初期半径を120から80に縮小
   - 影響力の初期強さを10から5に減少
   - レベルアップ時の強化幅を減少（影響力+10→+5、範囲+25→+10）
   - クールダウン最小値を0.3から0.5秒に変更
2. 経験値システムの調整
   - 敵キャラクター変化時の経験値獲得量を20から10に減少
   - レベルアップに必要な経験値を増加（15+(level-1)*15 → 20+(level-1)*20）

### 修正内容
1. 敵キャラクターのスプライトシート配置に合わせてアニメーション定義を正しく修正
   - 1段目（フレーム0-7）が上向きアニメーション
   - 4段目（フレーム24-31）が下向きアニメーション
2. ゲームクリア時の演出とリトライ方法の改善
   - キャラクタータップからより使いやすい画面タップに変更
   - ガイドテキストを「画面をタップしてリトライ！」に統一
3. 視覚エフェクトの安定性向上
   - 粒子エフェクトから単純な輝きエフェクトに置き換え
   - try-catchによるエラーハンドリング追加

### コード改善
- コードのコメントを追加し、アニメーション定義の意図を明確化
- エラー発生時のフォールバック処理の実装
- 不要なイベントリスナーの削除とクリーンアップ

## 次のステップ

### 短期的なタスク
1. **プレイテストと更なるバランス調整**
   - 難易度カーブの評価と調整
   - プレイ時間の最適化
2. **背景システムのさらなる改善**
   - 横スクロールの動きを自然にする
   - エッジ表示の最適化
3. **モバイルデバイスでのテスト強化**
   - タッチ操作の最適化
   - 様々な画面サイズでの表示確認
4. **パフォーマンス最適化**
   - 不要なオブジェクト生成の削減
   - レンダリング処理の効率化

### 中期的な計画
1. **コードのモジュール化**
   - 関連機能ごとにファイル分割
   - ES6モジュールの導入検討
2. **追加ゲーム要素の実装**
   - 新しい敵キャラクタータイプ
   - 追加の能力やスキル
3. **ユーザーフィードバックの収集と反映**
   - プレイテスト実施
   - ユーザビリティ改善

## 現在の意思決定と考慮事項

### 重要な決定事項
- **ゲームバランスの優先**: プレイヤー体験を向上させるためのバランス調整を優先
- **単一ファイル構造の維持**: 当面は単一ファイル構造を維持し、機能安定後にモジュール化を検討
- **エラーハンドリングの強化**: 主要機能には必ずtry-catchブロックを追加し、安定性を確保
- **互換性重視のアプローチ**: 最新機能よりも幅広いブラウザ互換性を優先

### 現在の懸念事項
- **プレイ難易度**: ゲームバランスがまだ最適ではない可能性
- **グローバル変数の過剰使用**: 状態管理がグローバル変数に依存しており、将来的に問題となる可能性
- **アセットの最適化**: 画像と音声のロード時間と使用メモリの最適化が必要
- **モバイル端末での操作性**: スマートフォンでのタッチ操作がデスクトップに比べて最適化が不足

## 重要なパターンとプラクティス

### コーディングスタイル
- **関数名の命名規則**: 動詞+名詞（例：`updatePlayerMovement`, `createBackground`）
- **変数名の命名規則**: キャメルケース、具体的な名前（`playerHealthBar`など）
- **コメント**: 複雑なロジックや非明示的な意図には必ずコメントを追加

### 使用パターン
- **コールバック関数**: Phaserのイベントとタイマーには匿名関数またはアロー関数を使用
- **状態管理**: 主にグローバル変数を通じて状態を管理
- **オブジェクト拡張**: Phaserスプライトにカスタムプロパティを追加してゲームロジックを実装

## プロジェクトの学びとインサイト

### 技術的学び
- Phaser.jsの物理エンジンはシンプルなゲームに適しているが、複雑な衝突処理には制限がある
- WebGLコンテキストのエラーハンドリングは特に重要であり、常にフォールバックを用意すべき
- モバイルブラウザでのオーディオ再生には、ユーザー操作後の開始など特別な考慮が必要

### ユーザー体験の洞察
- シンプルでも視覚的なフィードバックが豊富なほどユーザー満足度が高い
- リトライ機能はゲーム体験の重要な部分であり、わかりやすく実装する必要がある
- アニメーションの一貫性はゲームの没入感に大きく影響する
- 適切なゲームバランスは、プレイヤーの達成感とフラストレーションのバランスに大きく影響する 