# ペヨーテの旅路 - アクティブコンテキスト

## 現在の作業焦点

- **攻撃システムの実装**: ペヨーテの棘（緑色の弾）自動発射機能の実装
- **ゲームバランスの調整**: 影響力システムとレベル進行の難易度調整
- **敵キャラクターのアニメーション修正**: 上下移動時のアニメーション方向を修正（上向き・下向きのスプライト対応）
- **ゲームクリア後のリトライ機能の改善**: 画面全体をタップ可能領域として設定
- **エフェクト処理の安定化**: 攻撃エフェクトと衝突エフェクトの実装、エラーハンドリング追加

## 最近の変更点

### 新機能：ペヨーテの棘（攻撃システム）
1. 自動攻撃機能の実装
   - 1秒間隔で最も近い敵に向けて緑色の棘を自動発射
   - 敵がいない場合はランダムな方向に発射
   - スペースキーでも手動発射可能（デバッグ用）
2. 棘のビジュアルデザイン
   - 緑色の直線（メイン）と複数の側面棘からなるデザイン
   - 命中時のグリーンエフェクト
3. 棘の物理的特性
   - 直線的な移動
   - 敵に命中すると変身メーターを増加
   - 敵を強くノックバック
4. バグ修正と安定性向上
   - 棘が途中で止まる問題を修正
   - 画面外に出た棘を自動削除する機能

### バランス調整
1. 影響力システムの弱体化とバランス調整
   - 影響力の初期半径を120から80に縮小
   - 影響力の初期強さを10から5に減少
   - レベルアップ時の強化幅を減少（影響力+10→+5、範囲+25→+10）
   - クールダウン最小値を0.3から0.5秒に変更
2. 経験値システムの調整
   - 敵キャラクター変化時の経験値獲得量を10から20に増加
   - スコア獲得も10から20に増加

### 背景システムの改善
1. 背景の表示方法を改善
   - 背景画像を画面サイズの3倍に拡大
   - 画面のエッジが見えないようにポジショニングを調整
   - 自然なスクロール効果のために速度とバウンス範囲を調整

### 修正内容
1. 敵キャラクターのスプライトシート配置に合わせてアニメーション定義を正しく修正
   - 1段目（フレーム0-7）が上向きアニメーション
   - 4段目（フレーム24-31）が下向きアニメーション
2. ゲームクリア時の演出とリトライ方法の改善
   - キャラクタータップからより使いやすい画面タップに変更
   - ガイドテキストを「画面をタップしてリトライ！」に統一
3. 視覚エフェクトの安定性向上
   - 粒子エフェクトから単純な輝きエフェクトに置き換え
   - try-catchによるエラーハンドリング追加

### コード改善
- 棘の更新処理(updateSpines)関数の追加
- コードのコメントを追加し、アニメーション定義の意図を明確化
- エラー発生時のフォールバック処理の実装
- 不要なイベントリスナーの削除とクリーンアップ

## 次のステップ

### 短期的なタスク
1. **プレイテストと更なるバランス調整**
   - 攻撃システムと敵の強さのバランス評価
   - 難易度カーブの再調整
2. **敵キャラクターのAI改善**
   - より多様な動きパターンの追加
   - プレイヤーとの距離に応じた行動変化
3. **UIの拡張**
   - 攻撃クールダウン表示
   - 敵の変身状態の視覚的フィードバック強化
4. **モバイルデバイスでのテスト強化**
   - タッチ操作の最適化
   - 様々な画面サイズでの表示確認

### 中期的な計画
1. **コードのモジュール化**
   - 関連機能ごとにファイル分割
   - ES6モジュールの導入検討
2. **追加ゲーム要素の実装**
   - 新しい敵キャラクタータイプ
   - プレイヤーの特殊能力（棘の強化版など）
3. **ユーザーフィードバックの収集と反映**
   - プレイテスト実施
   - ユーザビリティ改善

## 現在の意思決定と考慮事項

### 重要な決定事項
- **攻撃システムの自動化**: プレイヤーの移動操作に集中できるよう、攻撃は自動化する方針を採用
- **視覚エフェクトの強化**: 攻撃とヒット時のフィードバックを強化し、ゲーム体験を向上
- **単一ファイル構造の維持**: 当面は単一ファイル構造を維持し、機能安定後にモジュール化を検討
- **エラーハンドリングの強化**: 主要機能には必ずtry-catchブロックを追加し、安定性を確保

### 現在の懸念事項
- **攻撃バランス**: 自動攻撃の頻度とダメージのバランスがまだ最適ではない可能性
- **複雑化するコード**: 新機能追加によりコードが複雑化しており、リファクタリングが必要になっている
- **アセットの最適化**: 画像と音声のロード時間と使用メモリの最適化が必要
- **モバイル端末での操作性**: スマートフォンでのタッチ操作がデスクトップに比べて最適化が不足

## 重要なパターンとプラクティス

### コーディングスタイル
- **関数名の命名規則**: 動詞+名詞（例：`updatePlayerMovement`, `createBackground`, `shootSpine`）
- **変数名の命名規則**: キャメルケース、具体的な名前（`playerHealthBar`, `spineCooldown`など）
- **コメント**: 複雑なロジックや非明示的な意図には必ずコメントを追加

### 使用パターン
- **コールバック関数**: Phaserのイベントとタイマーには匿名関数またはアロー関数を使用
- **状態管理**: 主にグローバル変数を通じて状態を管理
- **オブジェクト拡張**: Phaserスプライトにカスタムプロパティを追加してゲームロジックを実装
- **エラーハンドリング**: try-catchブロックを使用した堅牢な実装

## プロジェクトの学びとインサイト

### 技術的学び
- Phaser.jsの物理エンジンはシンプルなゲームに適しているが、弾の物理挙動に一部制限がある
- 物理オブジェクトの速度が思わぬ理由で減少することがあり、定期的な速度チェックが必要
- モバイルブラウザでのオーディオとタッチ操作には特別な考慮が必要

### ユーザー体験の洞察
- 自動攻撃システムは操作の複雑さを減らし、初心者プレイヤーに優しい体験を提供する
- 視覚的なフィードバック（ヒットエフェクト、変身エフェクト）はゲーム体験の質を大きく向上させる
- 適切なゲームバランスは、プレイヤーの達成感とフラストレーションのバランスに大きく影響する 